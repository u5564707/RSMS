<!doctype html>
<html>
<head>
<title>Research Sample Management System</title>

<link rel='stylesheet' href='css/reset.css'>
<link rel='stylesheet' href='css/style.css'>
<link rel="stylesheet" href="css/Treant.css">
<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/tabulator.css">
<link rel="stylesheet" href="css/jquery.contextMenu.min.css">
<link rel="stylesheet" href="css/swiper.min.css">
<link href="css/themes/tabulator_simple.css" rel="stylesheet">

<script src="js/jquery-3.1.js" type="text/javascript"></script>
<script src="js/jquery-ui-1.11.4/jquery-ui.min.js" type="text/javascript"></script>
<script src="js/jquery.contextMenu.min.js" type="text/javascript"></script>
<script src="js/tabulator.js" type="text/javascript"></script>
<script src="js/databaseFunctions.js" type="text/javascript"></script>
<script src="js/globalVariables.js" type="text/javascript"></script>
<script src="tests/unit.js" type="text/javascript"></script>

<style>
div {
	width: fit-content;
}
.swiper-container {
	width: 100%;
	height: 100%;
}
.swiper-slide {
	text-align: left;
	font-size: 18px;
	background: #fff;
	/* Center slide text vertically */
	/*display: -webkit-box;*/
	/*display: -ms-flexbox;*/
	/*display: -webkit-flex;*/
	/*display: flex;*/
	/*-webkit-box-pack: center;*/
	/*-ms-flex-pack: center;*/
	/*-webkit-justify-content: center;*/
	/*justify-content: center;*/
	/*-webkit-box-align: center;*/
	/*-ms-flex-align: center;*/
	/*-webkit-align-items: center;*/
	/*!*align-items: center;*!*/
}
.swiper-pagination-bullet {
	width: 20px;
	height: 20px;
	text-align: center;
	line-height: 20px;
	font-size: 12px;
	color:#000;
	opacity: 1;
	background: rgba(0,0,0,0.2);
}
.swiper-pagination-bullet-active {
	color:#fff;
	background: #007aff;
}
#mainPart{
	text-align: center;

	margin-right: auto; margin-left: auto;
}
</style>

<script src="js/raphael.js"></script>
<script src="js/Treant.js"></script>

</head>

<body>
	<header>
		<div id="file-name"></div>

		<ul>
			<li><a href='#' title='Minimize' id='windowControlMinimize'></a></li>
			<li><a href='#' title='Maximize' id='windowControlMaximize'></a></li>
			<li><a href='#' title='Close' id='windowControlClose'></a></li>
		</ul>
		
		<div id="navi-btn">
			<button id="main">Main</button>
			<button id="process">Process</button>
		</div>
	</header>

	<input style="display: none;" id="openFileDialog" type="file" />
	<input style="display: none;" id="saveAsFileDialog" type="file" nwsaveas />

	<!-- Swiper -->
	<div class="swiper-container">
		<div class="swiper-wrapper">
			<div class="swiper-slide">

				<!--swipe contents inside-->
				<div class="chart" id="tree"></div>
        <p> <br> </p>
        
				<div id="mainPart">
				<button id="add_table" style="display: none">Add new row</button>
				<!--<button id="delete_table">Delete Row</button>-->
				<!--<button id="add_col">Add new column</button><!--
				<button id="delete_col" style="display: none">Delete column</button>
				
				<!--<form class="forms" id='form1' style="display: none">
					<input type="text" id="txt_name" name="delete_row" placeholder="deleted row number">
				</form>
				<button class="buttons" id="del_row" style="display: none">Delete Row</button>-->
				<p> <br> </p>
				
				<form class="forms" id='form2' style="display: none">
					<input type="text" id="col_name" name="add_col" placeholder="new column name">
				</form>
				<button class="buttons" id="add_col" style="display: none">Add new column</button>
			  <p> <br> </p>
				
				<div class="tables" id="samples-table"></div>
				<p> <br> </p>
				
				<form class="forms" id='form3' style="display: none">
					<input type="text" id="col_del" name="del_col" placeholder="Choose column name">
				</form>
				<button class="buttons" id="del_col" style="display: none">Delete column</button>
				
				<!--<form id='form3'>-->
				<!--<input type="text" id="col_delete" name="delet_col" placeholder="column number">-->
				<!--</form>-->
				</div>
			</div>

			<!--second swiper-->
			<div class="swiper-slide">
				<div class="container">

					<!--<header>-->
						<!--<h1 class="new-column">Process and attributes</h1>-->
					<!--</header>-->
	
					<nav>
						<h2 id="processID" style="display: none">Process list</h2>
						<button id="addNewProcess" style="display: none">AddNewProcess</button>
						<ul id="ProcessList"></ul>
					</nav>
	
					<article>
						<p id="attriID" style="display: none">Attributes</p>
						<button id="addNewAttribute" style="display: none">Add New Attribute</button>
						<!--<button id="del-attri-table" style="display: none">DeleteAttributes</button>-->
						<button id="saveAttributes" style="display: none">SaveAttributes</button>
						<div class="attri-tables" id="attri-table"></div>
					</article>
				</div>
			</div>
		</div>
		<!-- Add Pagination -->
		<!--<div class="swiper-pagination"></div>-->
	</div>

	<!-- Initialize Swiper -->
	<script src="js/swiper.min.js"></script>
	<script>
		var swiper = new Swiper('.swiper-container', {
			pagination: '.swiper-pagination',
			paginationClickable: true,
			nextButton: '#process',
			prevButton: '#main',
			paginationBulletRender: function (index, className) {
				return '<span class="' + className + '">' + (index + 1) + '</span>';
			}
		});
	</script>

	<!--<div class="chart" id="tree"></div>-->

	<!--<button id="save_table">Save</button>-->
	<!--<button id="add_table">Add new row</button>-->
	<!--&lt;!&ndash;<button id="delete_table">Delete Row</button>&ndash;&gt;-->
	<!--&lt;!&ndash;<button id="add_col">Add new column</button>&ndash;&gt;-->
	<!--&lt;!&ndash;<button id="del_col">Delete column</button>&ndash;&gt;-->
	<!--<button id="delete_col">Delete column</button>-->
	<!--<form class="forms" id='form1'>-->
		<!--<input type="text" id="txt_name" name="delete_row" placeholder="deleted row number">-->
	<!--</form>-->
	<!--<button class="buttons" id="del_row">Delete Row</button>-->

	<!--<form class="forms" id='form2'>-->
		<!--<input type="text" id="col_name" name="add_col" placeholder="new column name">-->
	<!--</form>-->
	<!--<button class="buttons" id="add_col">Add new column</button>-->

	<!--<form class="forms" id='form3'>-->
		<!--<input type="text" id="col_del" name="del_col" placeholder="Choose column name">-->
	<!--</form>-->
	<!--<button class="buttons" id="del_col">Delete column</button>-->
	<!--&lt;!&ndash;<form id='form3'>&ndash;&gt;-->
	<!--&lt;!&ndash;<input type="text" id="col_delete" name="delet_col" placeholder="column number">&ndash;&gt;-->
	<!--&lt;!&ndash;</form>&ndash;&gt;-->

	<!--<div class="tables" id="samples-table"></div>-->

	<!--<script src="js/jquery-2.2.4.min.js" type="text/javascript"></script>-->
	<!--<script src="js/jquery-ui-1.11.4/jquery-ui.min.js" type="text/javascript"></script>-->
	<!--<script src="js/jquery.contextMenu.min.js" type="text/javascript"></script>-->
	<!--<script src="js/tabulator.js" type="text/javascript"></script>-->
	<!--<script src="js/databaseFunctions.js" type="text/javascript"></script>-->
	<!--<script src="js/globalVariables.js" type="text/javascript"></script>-->
	<!--<script src="tests/unit.js" type="text/javascript"></script>-->
	<script>
		require('nw.gui').Window.get().showDevTools(); // open DevTools

		var fs       = require('fs'),
		    nw       = require('nw.gui'),
		    tosource = require('tosource'),
		    win      = nw.Window.get();

		win.isMaximized = false;

		// min
		document.getElementById('windowControlMinimize').onclick = function() {
			win.minimize();
		};

		// close
		document.getElementById('windowControlClose').onclick = function() {
			win.close();
		};

		// max
		document.getElementById('windowControlMaximize').onclick = function() {
			if (win.isMaximized)
				win.unmaximize();
			else
				win.maximize();
		};

		win.on('maximize', function() {
			win.isMaximized = true;
		});

		win.on('unmaximize', function() {
			win.isMaximized = false;
		});

		// Window menu
		var windowMenu = new nw.Menu({
			type : 'menubar'
		});

		// File menu
		var fileMenu = new nw.Menu();

		// Add file menu
		windowMenu.append(new nw.MenuItem({
			label : 'File',
			submenu : fileMenu
		}));

		// new project
		fileMenu.append(new nw.MenuItem({
			label : 'New Project',
			click : function() {
				initialiseUserData();
				setOpenedFileLocation(null);
				setLastClickedNode(null);
				projectOpened = true;
				
				$("#add_table").hide();
				$("#form2").hide();
        $("#add_col").hide();
        $("#form3").hide();
        $("#del_col").hide();
				$("#samples-table").hide();
				
				$("#processID").show();
				$("#addNewProcess").show();
				
				$("#attri-table").hide();
	      $("#attriID").hide();
	      $("#addNewAttribute").hide();
	      $("#saveAttributes").hide();
			}
		}));

		// open project
		fileMenu.append(new nw.MenuItem({
			label : 'Open Project',
			click : function() {
				var chooser = document.querySelector('#openFileDialog');

				console.log("browsing files...");
				chooser.addEventListener("change", function(evt) {
					console.log(this.value + " selected!");
					
					document.getElementById("file-name").innerText = this.value;
					document.title = this.value;
					
					console.log("checking file...");
					//if (this.value.includes(".") || this.value == "") {
					if (this.value == "") {
						console.log("invalid file!");

						//alert("Please load a valid project file"); // uncomment when queueing problem is fixed
					} else {
						console.log("valid file!");

						copyToUserData(this.value);
						setOpenedFileLocation(this.value);
						setLastClickedNode(null);
						projectOpened = true;
						
						$("#add_table").hide();
						$("#form2").hide();
		        $("#add_col").hide();
		        $("#form3").hide();
		        $("#del_col").hide();
		        $("#samples-table").hide();
		        
		        $("#processID").show();
		        $("#addNewProcess").show();
		        
		        $("#attri-table").hide();
		        $("#attriID").hide();
		        $("#addNewAttribute").hide();
		        $("#saveAttributes").hide();
					}
					this.value = null; // reset file location
				}, false);

				chooser.click();
			}
		}));

		// save
		fileMenu.append(new nw.MenuItem({
			label : 'Save',
			click : function() {
				getLastClickedNode(function(nodeID) {
					saveTable(nodeID, function() {
	          if (!projectOpened) {
	            alert("No project opened!");
	          } else {
	            getOpenedFileLocation(function(location) {
	              if (location == null) {
	                var chooser = document.querySelector('#saveAsFileDialog');
	    
	                chooser.addEventListener("change", function(evt) {
	                  copyFromUserData(this.value);
	                  this.value = null; // reset file location
	                }, false);
	  
	                chooser.click();
	              } else {
	                copyFromUserData(location);
	              }
	            });
	          }
					});
				});
			}
		}));

		// save as
		fileMenu.append(new nw.MenuItem({
			label : 'Save As',
			click : function() {
				getLastClickedNode(function(nodeID) {
					saveTable(nodeID, function() {
						if (!projectOpened) {
	            alert("No project opened!");
	          } else {
	            var chooser = document.querySelector('#saveAsFileDialog');
	  
	            chooser.addEventListener("change", function(evt) {
	              if (this.value != "") {
	                copyFromUserData(this.value);
	                setOpenedFileLocation(this.value);
	                this.value = null; // reset file location
	              }
	            }, false);
	  
	            chooser.click();
	          }
	        });
				});
			}
		}));

		// exit
    fileMenu.append(new nw.MenuItem({
      label : 'Exit',
      click : function() {
        win.close();
      }
    }));
		
		// Assign to window
		nw.Window.get().menu = windowMenu;

		//createTestData(); // for testing

		var initialProject = function() {
			getTreeConfig(function(chart_config) {
				$("#tree").empty();
				new Treant(chart_config);
			});

			
			$.contextMenu({
				selector : ".node",
				trigger : 'left',
				items : {
					view : {
						name : "View Samples",
						callback : function(key, opt) {
              $("#samples-table").show();

							//document.getElementsByClassName("table").style.display = "block"
							//document.getElementsByClassName("table").style.visibility = "visible";

							// save table then update data
							getLastClickedNode(function(nodeID) {
								if (nodeID == null) {
									// update columns
                  getProcessAttributeNames(opt.$trigger.attr("id"), function(columns) {
                    $("#samples-table").tabulator("setColumns", columns, false);
                    
                    // update samples (relies on columns to be set)
                    getNodeSamples(opt.$trigger.attr("id"), function(samples) {
                      $("#samples-table").tabulator("setData", samples);
                    });
                  });
                  
                  setLastClickedNode(opt.$trigger.attr("id"));
								} else {
									saveTable(nodeID, function() {
										
										// update columns
			              getProcessAttributeNames(opt.$trigger.attr("id"), function(columns) {
			                $("#samples-table").tabulator("setColumns", columns, false);
			                
			                // update samples (relies on columns to be set)
			                getNodeSamples(opt.$trigger.attr("id"), function(samples) {
		                    $("#samples-table").tabulator("setData", samples);
			                });
			              });
										
										setLastClickedNode(opt.$trigger.attr("id"));
									});
								}
							});

							$("#samples-table").tabulator("redraw");
							$("#samples-table").tabulator("setPageSize", 5); // show 50 rows per page

							// show table operations
							if (opt.$trigger.attr("id") == "rootNode") {
								$("#add_table").show();
							} else {
								$("#add_table").hide();
							}
							//$("#del_row").show();
							//$("#form1").show();
							$("#form2").show();
							$("#add_col").show();
							$("#form3").show();
							$("#del_col").show();
							
							//document.getElementsByClassName("forms").style.display = "block";
							//document.getElementById("forms").style.visibility = "visible";
							//document.getElementById("buttons").style.display = "block";
							//document.getElementById("buttons").style.visibility = "visible";
						}
					},
					processSamples : {
						name : "Process Samples",
						callback : function(key, opt) {
							var processName = prompt("Process name:"),
							    samplesString = prompt("Samples to process (enter ids as comma seperated values witout spaces):");

							if (processName != null && samplesString != null) {
								processSamples(processName, opt.$trigger.attr("id"),
										samplesString);
							}

							// update tree
							$("#tree").empty();
							getTreeConfig(function(config) {
								new Treant(config);
							});
						}
					}
				}
			});

			// define table
			$("#samples-table").tabulator({
				fitColumns : true,
				columns : []
				//pagination : true, // uncomment for final version
			});

			// delete a column
			//      $("#delete_col").click(function(){
			//        var columns = $("#samples-table").tabulator('getColumns');
			//
			//        var delCol = $("#col_delete").val();
			//        if (delCol > -1) {
			//          var newcol = columns.splice(delCol, 1);
			//        }
			//
			//        $('#samples-table').tabulator('setColumns', newcol);
			//      });

			// add rows
			$("#add_table").click(function() {

				$("#samples-table").tabulator("addRow", { id: ""+samplesTableRowCount++ });
				this.clearQueue();
			});




			$("#add_col").on('click',function() {
					var count = 1;
					console.log("first time"+ count);
					var thiscolumns = $("#samples-table").tabulator('getColumns');
					var temp1 = $("#samples-table").tabulator("getData");

					var newCol = $("#col_name").val();

					if ($("#col_name").val() == "") {
						newCol = prompt("Please enter the column name");
						count++;
						console.log("Second time" + count);
					}

					if(newCol==null){
						return;
						count++;
						console.log("Third time" + count);

					}else {
						thiscolumns.push({
							title: "" + newCol,
							field: "" + newCol,
							fitColumns: true,
							sorter: "string",
							editable:true,
							editableTitle:true
						});
					}

					db.update({
						_id : "DNA Extract"
					}, {
						$push : {
							attributeNames : "" + newCol
						}
					});

					//manipulate columns definition array
					$('#samples-table').tabulator('setColumns', thiscolumns,false);
					$("#samples-table").tabulator("setData", temp1);
					newCol == "";
				this.clearQueue();

			});


			// add columns
//			$("#add_col").click(function() {
//				var count = 1;
//				console.log("first time"+ count);
//				var thiscolumns = $("#samples-table").tabulator('getColumns');
//				var temp1 = $("#samples-table").tabulator("getData");
//
//				var newCol = $("#col_name").val();
//
//				if ($("#col_name").val() == "") {
//					newCol = prompt("Please enter the column");
//					count++;
//					console.log("Second time" + count);
//				}
//
//				if(newCol==null){
//					return;
//					count++;
//					console.log("Third time" + count);
//
//				}else {
//					thiscolumns.push({
//						title: "" + newCol,
//						field: "" + newCol,
//						fitColumns: true,
//						sorter: "string",
//						editable: true
//					});
//				}
//
//				db.update({
//					_id : "DNA Extract"
//				}, {
//					$push : {
//						attributeNames : "" + newCol
//					}
//				});
//
//				//manipulate columns definition array
//				$('#samples-table').tabulator('setColumns', thiscolumns,false);
//				$("#samples-table").tabulator("setData", temp1);
//				newCol == "";
//
//
//				$("#add_col").unbind('click').on('click', function() {
//					// function body
//				});
//
//			});

			//delete column
			$("#del_col").on('click',function() {
				var tmp = $("#col_del").val();
				if (tmp == "") {
					tmp = prompt("Please enter the name of the column to delete");
				}
				$("#samples-table").tabulator("deleteColumn", tmp);
				/*var thiscolumns = $("#samples-table").tabulator('getColumns');
				var temp1 = $("#samples-table").tabulator("getData");

				getLastClickedNode(function(nodeID) {
					db.remove({
						_id : {
							nodeID : nodeID,
							sampleID : tmp
						}
					}, {
						multi : true
					});
				});

				$('#samples-table').tabulator('setColumns', thiscolumns);
				var x = $("#samples-table").tabulator("getData");
				$("#samples-table").tabulator("setData", x);
				console.log(tosource(x));*/
			});

			/*// delete row
			$("#delete_table").one('click',function() {
				var bla = $("#txt_name").val();
				if (bla == "") {
					bla = prompt("Please enter the row");
				}
				$("#samples-table").tabulator("deleteRow", bla);

				getLastClickedNode(function(nodeID) {
					db.remove({
						_id : {
							nodeID : nodeID,
							sampleID : bla
						}
					}, {
						multi : true
					});
				});

				var x = $("#samples-table").tabulator("getData");
				$("#samples-table").tabulator("setData", x);
				console.log(tosource(x));
			});*/
			
			// populate process list
	    getAllProcessIDs(function(ids) {
	      $("#ProcessList").empty();

	      for (var i in ids) {
	        $("#ProcessList").append('<li id='+ids[i]+'><a href="#">'+ids[i]+'</a></li>');
	      }
	    });
		};

		// saves the current state of samples-table
		function saveTable(nodeID, callback) {
      if (nodeID != null) {
        console.log("saving column headers for node "+nodeID+"...");
        updateProcess(nodeID, $("#samples-table").tabulator("getColumns"));
        console.log("saved!");
        
        console.log("saving sample data for node "+nodeID+"...");
        updateNodeSamples(nodeID, $("#samples-table").tabulator("getData"));
        console.log("saved!");
      }

      callback();
    }
		
		//click the first list demo
//		$("#attriID-1").one('click',function() {
//			$("#attri-table").tabulator({
//				columns: [
//					{title: "Name", field: "name", sortable: true, sorter: "string", width: 200, editable: true},
//
//				]
//			});
//
//			$("#attri-table").tabulator("setData", [
//				{id: 1, name: "Billy Bob"}
//			]);
//		});
		
		// add new attribute
		$("#addNewAttribute").click(function() {
			$("#attri-table").tabulator("addRow", { id: attriTableRowCount, name: "attr"+attriTableRowCount++ });
		});

		//add new process
		$("#addNewProcess").click(function(){

			var ul = document.getElementById("ProcessList");
			var li = document.createElement("li");
			var t1 = prompt("Name of the new process?");
			li.appendChild(document.createTextNode(t1));
			li.setAttribute("id", t1); // added line
			ul.appendChild(li);
			//alert(li.id);

			//var samplesString2 = prompt("Samples to process (enter ids as comma seperated values witout spaces):");


			var lis = $("#ProcessList li");

			//var par = ul.childNodes[lis.length-2].innerText;

			//console.log(par);

//			if (t1 != null && samplesString2 != null) {
//				processSamples(t1, par+"[id]",
//						samplesString2);
//			}
      console.log("adding process"+t1);
			addProcess(t1);

			// update tree
			$("#tree").empty();
			getTreeConfig(function(config) {
				new Treant(config);
			});
			
			$("#attri-table").hide();
      $("#attriID").hide();
      $("#addNewAttribute").hide();
      $("#saveAttributes").hide();
		});

		// click process ul
		$("#ProcessList").on("click",function(){
			console.log("list clicked");

			$("li").on("click",function() {
				console.log("list element clicked");
				
				// define table
	      $("#attri-table").tabulator({
	        columns : []
	      });

				// set columns
	      $("#attri-table").tabulator("setColumns", [
          { formatter: deleteButton, align: "center", width: 50, onClick: function(e, cell, val, data) {
            console.log("deleting row "+data.id);
            $("#attri-table").tabulator("deleteRow", data.id);
          } },
          { title: ""+this.innerText, field: "name", sortable: true, sorter: "string", width: 200, editable: true }
        ]);
				
				// set data
				getAttributeNames(this.innerText, function(attributeNames) {
					$("#attri-table").tabulator("setData", attributeNames);
				});
				
				setLastClickedProcess(this.innerText);
				
				$("#attri-table").show();
				$("#attriID").show();
        $("#addNewAttribute").show();
        $("#saveAttributes").show();

				this.clearQueue();
			});

			this.clearQueue();
		});

		/*$("#del-attri-table").on('click',function() {
			var bla2 = $("#txt_name").val();
			if (bla2 == "") {
				bla2 = prompt("Please enter the row");
			}
			$("#attri-table").tabulator("deleteRow", bla2);

			var x = $("#attri-table").tabulator("getData");
			$("#attri-table").tabulator("setData", x);
			console.log(tosource(x));
		});*/
		
		// save list of attributes
		$("#saveAttributes").on('click',function() {
			getLastClickedProcess(function(processID) {
        if (processID != undefined && confirm('Save data?')) {
          updateProcessAttributes(processID, $("#attri-table").tabulator("getData"));
			this.clearQueue();
        }
			});
		});

	</script>
</body>
</html>