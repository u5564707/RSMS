<!doctype html>
<html>
<head>
    <title>Research Sample Management System</title>

    <link rel='stylesheet' href='css/reset.css'>
    <link rel='stylesheet' href='css/style.css'>
    <link rel="stylesheet" href="css/Treant.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/tabulator.css">
    <link rel="stylesheet" href="css/jquery.contextMenu.min.css">
    
    <style>
	    div {
		    width: fit-content;
		    /*height: fit-content;*/
	    }
    </style>

    <script src="js/raphael.js"></script>
    <script src="js/Treant.js"></script>
    
    <script>
        // Is this script needed? It's giving an error. I don't know if it's
        // because I did something wrong. The same code is run at the start of
        // the body script.
	    /*
	    var nw = require('nw.gui'),
	    var win = nw.Window.get();
	    win.isMaximized = false;
	    */
    </script>
</head>

<body>
    <header>
	    <ul>
		    <li><a href='#' title='Minimize' id='windowControlMinimize'></a></li>
		    <li><a href='#' title='Maximize' id='windowControlMaximize'></a></li>
		    <li><a href='#' title='Close'    id='windowControlClose'   ></a></li>
	    </ul>
    </header>

    <div class="chart" id="tree"></div>
    <button id="save_table">Save</button>
    <button id="add_table">Add new row</button>
    <button id="delete_table">Delete</button>
    <form id='form1'>
        <input type="text" id="txt_name" name="delete_row" placeholder="Enter the row">
    </form>
	<div id="samples-table"></div>
	
	<script src="js/jquery-2.2.4.min.js" type="text/javascript"></script>
	<script src="js/jquery-ui-1.11.4/jquery-ui.min.js" type="text/javascript"></script>
	<script src="js/jquery.contextMenu.min.js" type="text/javascript"></script>
	<script src="js/tabulator.js" type="text/javascript"></script>
	<script src="databaseFunctions.js" type="text/javascript"></script>

	<script>
        $("#delete_table").hide();
        $("#save_table").hide();
        $("#add_table").hide();
        $("#form1").hide();
        var fs = require('fs'),
            nw = require('nw.gui'),
            tosource = require('tosource'),
	        win = nw.Window.get();
    
	    win.isMaximized = false;

	    // min
	    document.getElementById('windowControlMinimize').onclick = function() {
		    win.minimize();
	    };

	    // close
	    document.getElementById('windowControlClose').onclick = function() {
		    win.close();
	    };

	    // max
	    document.getElementById('windowControlMaximize').onclick = function() {
		    if (win.isMaximized)
			    win.unmaximize();
		    else
			    win.maximize();
	    };

	    win.on('maximize', function() {
		    win.isMaximized = true;
	    });

	    win.on('unmaximize', function() {
		    win.isMaximized = false;
	    });
	    
	    createTestData2(); // for testing

        $(document).ready(function() {
            getTreeConfig(function(chart_config) {
                new Treant(chart_config);

                // define the context menu for clicks on the tree
                $.contextMenu({
                    // define which elements trigger this menu
                    selector: ".node",
                    trigger: 'left',
                    // define the elements of the menu
                    items: {
                        view: {
                            name: "view samples",
                            callback: function(key, opt) {
	                            
	                            // update columns
	                            getProcessAttributeNames(opt.$trigger.attr("id"), function(columns) {  
                                    $("#samples-table").tabulator("setColumns", columns , false);
		                        });
	                            
	                            // update table data
	                            getNodeSamples(opt.$trigger.attr("id"), function(samples) {
                                    $("#samples-table").tabulator("setData", samples);
                                });

                                $("#delete_table").show();
                                $("#save_table").show();
                                $("#add_table").show();
                                $("#form1").show();
                            }
                        },
                        edit: {
                            name: "save",
                            icon: "edit",
                            callback: function(key, opt) {
	                            console.log("save!");


                                //get the column
                                var colDefs = $("#samples-table").tabulator("getColumns");
                                console.log(tosource(colDefs));

                                //get the table data
                                var thisdata = $("#samples-table").tabulator("getData");
                                tabledata = thisdata;
                                var content = tosource(tabledata);
                                var mydata = tosource(tabledata);

                                console.log("my data is: ");
                                console.log(mydata);

                                console.log("my datatostring is: ");
                                console.log(mydata.toString());

                                $.each(eval(mydata), function(i, v) {

                                    $.each(v, function(ii, vv) {


                                            console.log(vv)

                                    })

                                });

                                console.log("start save file");

                                fs.writeFile('saved.txt',content,function(err){
                                    if(err)
                                        alert('Error writing file');
                                    else
                                    {
                                        fs.readFile('./saved.txt',function(err,fileContent){
                                            if(err)
                                                document.write('Error reading file');
                                            else
                                                document.write(fileContent.toString().replace(new RegExp(os.EOL,'g'),'<br>'))
                                        })
                                    }
                                });
                            }
                        }
                    },
                    callback: function(itemKey, opt) {
                        // this is the default callback if there is no 'item' callback
                        alert("Clicked on " + itemKey + " on element " + opt.$trigger.attr("id"));
                    }
                });
                
                // define table
                $("#samples-table").tabulator({
                    fitColumns: true,
                    columns: [],

                    //when edited save the changes
                    rowEdit: function(id, data, row) {
                        // id - the id of the row
                        // data - the data for the row
                        // row - the DOM element of the row
                        $(window).resize(function(){
                            $("#samples-table").tabulator("redraw");
                        });

                        var thisdata = $("#samples-table").tabulator("getData");
                        console.log(tosource(thisdata));
                        console.log("thisdata");
                        tabledata = thisdata;

                        // clear the table
                        $("#samples-table").tabulator("clear");

                        $("#samples-table").tabulator("setData", tabledata);



                       // updateNodeSamples(tabledata);
                        //alert("Data is "+tabledata.toSource());
                    }
                });
            });
        });


        //Add/Del Rows Example
        $("#add_table").click(function(){
            $("#samples-table").tabulator("addRow");
        })


        //there is an error when get the input's value, I am emailed the owner for the details
        $("#delete_table").click(function(){
            var bla = $("#txt_name").val();
            $("#samples-table").tabulator("deleteRow",1);
            console.log(bla);
        })


        //click the save button
        $("#save_table").click(function(){
		    var content = tosource(tabledata);

            //make new directory
//			var mkdirp = require('mkdirp');
//
//			// Create a folder, recursively
//			mkdirp('./a/sub/dir', function(err){
//				if (err)
//					alert('Error creating directories');
//			});
		    //var content = JSON.stringify(tabledata);
		    console.log(content);


		    fs.writeFile('saved.txt',content,function(err){
			    if(err)
				    alert('Error writing file');
			    else
			    {
				    fs.readFile('./saved.txt',function(err,fileContent){
					    if(err)
						    document.write('Error reading file');
					    else
						    document.write(fileContent.toString().replace(new RegExp(os.EOL,'g'),'<br>'))
				    })
			    }
		    });
	    })
    </script>
</body>
</html>

